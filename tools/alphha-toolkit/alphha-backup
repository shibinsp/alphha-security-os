#!/bin/bash
#===============================================================================
#
#          FILE: alphha-backup
#
#         USAGE: alphha-backup [OPTIONS] <source>
#
#   DESCRIPTION: Secure evidence collection and backup utility for forensics
#                Creates verified copies with hashes for chain of custody.
#
#        AUTHOR: Alphha Team
#     COPYRIGHT: Copyright (c) 2026 Alphha Team
#       LICENSE: BSD-3-Clause
#       VERSION: 1.0.0
#
#===============================================================================

set -euo pipefail

readonly VERSION="1.0.0"
readonly GREEN='\033[0;32m'
readonly CYAN='\033[0;36m'
readonly YELLOW='\033[0;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

log_info()    { echo -e "${GREEN}[+]${NC} $*"; }
log_warn()    { echo -e "${YELLOW}[!]${NC} $*"; }
log_error()   { echo -e "${RED}[-]${NC} $*" >&2; }
log_step()    { echo -e "${CYAN}[*]${NC} $*"; }

print_banner() {
    echo -e "${GREEN}"
    cat << 'EOF'
    _    _       _     _
   / \  | |_ __ | |__ | |__   __ _
  / _ \ | | '_ \| '_ \| '_ \ / _` |
 / ___ \| | |_) | | | | | | | (_| |
/_/   \_\_| .__/|_| |_|_| |_|\__,_|
          |_|  Evidence Backup Tool
EOF
    echo -e "${NC}"
}

usage() {
    cat << EOF
Usage: alphha-backup [OPTIONS] <source>

Secure evidence collection with forensic integrity.

ARGUMENTS:
    source              File, directory, or device to backup

OPTIONS:
    -o, --output        Output directory (default: ./evidence)
    -c, --case          Case number/identifier
    -e, --examiner      Examiner name
    -n, --notes         Additional notes
    --compress          Compress the backup
    --encrypt           Encrypt the backup (GPG)
    -h, --help          Show help

EXAMPLES:
    alphha-backup /dev/sda1 -o /evidence -c "CASE-2026-001"
    alphha-backup ./logs -c "IR-001" -e "John Doe" --compress
    alphha-backup /home/user --encrypt -c "CASE-123"

COPYRIGHT:
    Copyright (c) 2026 Alphha Team

EOF
    exit 0
}

# Default values
SOURCE=""
OUTPUT_DIR="./evidence"
CASE_ID="UNKNOWN"
EXAMINER="$(whoami)"
NOTES=""
COMPRESS=false
ENCRYPT=false

parse_args() {
    if [[ $# -eq 0 ]]; then
        usage
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -o|--output)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            -c|--case)
                CASE_ID="$2"
                shift 2
                ;;
            -e|--examiner)
                EXAMINER="$2"
                shift 2
                ;;
            -n|--notes)
                NOTES="$2"
                shift 2
                ;;
            --compress)
                COMPRESS=true
                shift
                ;;
            --encrypt)
                ENCRYPT=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            *)
                if [[ -z "$SOURCE" ]]; then
                    SOURCE="$1"
                    shift
                else
                    log_error "Unknown option: $1"
                    usage
                fi
                ;;
        esac
    done

    if [[ -z "$SOURCE" ]]; then
        log_error "Source is required"
        usage
    fi
}

create_evidence_package() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local evidence_dir="$OUTPUT_DIR/${CASE_ID}_${timestamp}"

    mkdir -p "$evidence_dir"

    log_step "Creating evidence package: $evidence_dir"

    # Create chain of custody document
    local custody_file="$evidence_dir/chain_of_custody.txt"
    cat > "$custody_file" << EOF
================================================================================
                    CHAIN OF CUSTODY DOCUMENT
================================================================================

Case ID:        $CASE_ID
Evidence ID:    ${CASE_ID}_${timestamp}
Date/Time:      $(date -u '+%Y-%m-%d %H:%M:%S UTC')
Examiner:       $EXAMINER
Hostname:       $(hostname)
Source:         $SOURCE
Notes:          $NOTES

================================================================================
                    SYSTEM INFORMATION
================================================================================

Kernel:         $(uname -r)
OS:             $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2 2>/dev/null || uname -o)
Tool:           Alphha Security OS - alphha-backup v$VERSION

================================================================================
                    ACQUISITION DETAILS
================================================================================

EOF

    # Get source information
    if [[ -b "$SOURCE" ]]; then
        # Block device
        echo "Type:           Block Device" >> "$custody_file"
        echo "Device:         $SOURCE" >> "$custody_file"
        fdisk -l "$SOURCE" 2>/dev/null >> "$custody_file" || true
    elif [[ -d "$SOURCE" ]]; then
        # Directory
        echo "Type:           Directory" >> "$custody_file"
        echo "Path:           $(realpath "$SOURCE")" >> "$custody_file"
        echo "Size:           $(du -sh "$SOURCE" 2>/dev/null | cut -f1)" >> "$custody_file"
        echo "Files:          $(find "$SOURCE" -type f 2>/dev/null | wc -l)" >> "$custody_file"
    else
        # File
        echo "Type:           File" >> "$custody_file"
        echo "Path:           $(realpath "$SOURCE")" >> "$custody_file"
        echo "Size:           $(stat -c%s "$SOURCE" 2>/dev/null || stat -f%z "$SOURCE") bytes" >> "$custody_file"
    fi

    echo "" >> "$custody_file"

    # Perform backup
    log_step "Acquiring evidence..."
    local backup_file="$evidence_dir/evidence"

    if [[ -b "$SOURCE" ]]; then
        # Use dcfldd or dd for block devices
        if command -v dcfldd &>/dev/null; then
            dcfldd if="$SOURCE" of="${backup_file}.dd" hash=sha256 hashlog="${evidence_dir}/hash_acquisition.txt" 2>&1 | tee -a "$custody_file"
        elif command -v dc3dd &>/dev/null; then
            dc3dd if="$SOURCE" of="${backup_file}.dd" hash=sha256 log="${evidence_dir}/hash_acquisition.txt" 2>&1 | tee -a "$custody_file"
        else
            dd if="$SOURCE" of="${backup_file}.dd" bs=4M status=progress 2>&1 | tee -a "$custody_file"
        fi
        backup_file="${backup_file}.dd"
    else
        # Use tar for files/directories
        tar -cvf "${backup_file}.tar" -C "$(dirname "$SOURCE")" "$(basename "$SOURCE")" 2>&1 | tee -a "$custody_file"
        backup_file="${backup_file}.tar"
    fi

    # Compress if requested
    if [[ "$COMPRESS" == true ]]; then
        log_step "Compressing evidence..."
        gzip -9 "$backup_file"
        backup_file="${backup_file}.gz"
    fi

    # Generate hashes
    log_step "Generating verification hashes..."
    local hash_file="$evidence_dir/hashes.txt"

    echo "================================================================================
                    HASH VERIFICATION
================================================================================
" >> "$custody_file"

    echo "MD5:    $(md5sum "$backup_file" | cut -d' ' -f1)" | tee -a "$custody_file" "$hash_file"
    echo "SHA1:   $(sha1sum "$backup_file" | cut -d' ' -f1)" | tee -a "$custody_file" "$hash_file"
    echo "SHA256: $(sha256sum "$backup_file" | cut -d' ' -f1)" | tee -a "$custody_file" "$hash_file"
    echo "SHA512: $(sha512sum "$backup_file" | cut -d' ' -f1)" | tee -a "$custody_file" "$hash_file"

    # Encrypt if requested
    if [[ "$ENCRYPT" == true ]]; then
        log_step "Encrypting evidence..."
        if command -v gpg &>/dev/null; then
            gpg --symmetric --cipher-algo AES256 "$backup_file"
            rm "$backup_file"
            backup_file="${backup_file}.gpg"
            log_info "Evidence encrypted. Remember your passphrase!"
        else
            log_warn "GPG not available, skipping encryption"
        fi
    fi

    # Final custody entry
    echo "
================================================================================
                    ACQUISITION COMPLETE
================================================================================

Completed:      $(date -u '+%Y-%m-%d %H:%M:%S UTC')
Final File:     $(basename "$backup_file")
Final Size:     $(stat -c%s "$backup_file" 2>/dev/null || stat -f%z "$backup_file") bytes

================================================================================
" >> "$custody_file"

    # Create verification script
    cat > "$evidence_dir/verify.sh" << 'VERIFY'
#!/bin/bash
# Evidence verification script
echo "Verifying evidence integrity..."
if [ -f "hashes.txt" ]; then
    sha256sum -c <(grep SHA256 hashes.txt | sed 's/SHA256: *//')
else
    echo "Hash file not found!"
    exit 1
fi
VERIFY
    chmod +x "$evidence_dir/verify.sh"

    log_info "Evidence package created: $evidence_dir"
    log_info "Chain of custody: $custody_file"
}

main() {
    print_banner
    parse_args "$@"

    log_info "Source: $SOURCE"
    log_info "Output: $OUTPUT_DIR"
    log_info "Case ID: $CASE_ID"
    log_info "Examiner: $EXAMINER"
    echo ""

    create_evidence_package

    echo ""
    log_info "Evidence collection complete!"
}

main "$@"
