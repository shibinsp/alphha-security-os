#!/bin/bash
#===============================================================================
#
#          FILE: alphha-menu
#
#         USAGE: alphha-menu
#
#   DESCRIPTION: Terminal-based security tools launcher for Alphha Security OS
#
#        AUTHOR: Alphha Team
#     COPYRIGHT: Copyright (c) 2026 Alphha Team
#       LICENSE: BSD-3-Clause
#       VERSION: 1.0.0
#
#===============================================================================

set -euo pipefail

readonly VERSION="1.0.0"
readonly GREEN='\033[0;32m'
readonly CYAN='\033[0;36m'
readonly YELLOW='\033[0;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'
readonly BOLD='\033[1m'

# Check for dialog
if ! command -v dialog &>/dev/null; then
    echo "Error: dialog is not installed. Installing..."
    sudo apt-get install -y dialog
fi

print_banner() {
    clear
    echo -e "${GREEN}"
    cat << 'EOF'
    _    _       _     _
   / \  | |_ __ | |__ | |__   __ _
  / _ \ | | '_ \| '_ \| '_ \ / _` |
 / ___ \| | |_) | | | | | | | (_| |
/_/   \_\_| .__/|_| |_|_| |_|\__,_|
          |_|  Security Tools Menu
EOF
    echo -e "${NC}"
}

# Tool categories
declare -A CATEGORIES=(
    ["01"]="Information Gathering"
    ["02"]="Vulnerability Analysis"
    ["03"]="Web Application Testing"
    ["04"]="Password Attacks"
    ["05"]="Wireless Attacks"
    ["06"]="Exploitation Frameworks"
    ["07"]="Post-Exploitation"
    ["08"]="Forensics & Recovery"
    ["09"]="Reverse Engineering"
    ["10"]="Network Analysis"
    ["11"]="Defensive Security"
    ["12"]="Anonymity & Privacy"
    ["13"]="Reporting Tools"
    ["14"]="System Administration"
    ["15"]="Alphha Toolkit"
)

# Tools per category
get_tools() {
    local category="$1"
    case "$category" in
        "01")
            echo "nmap masscan netdiscover arp-scan dnsrecon dnsenum theharvester recon-ng enum4linux nbtscan"
            ;;
        "02")
            echo "nikto wpscan sqlmap testssl.sh sslscan lynis unix-privesc-check"
            ;;
        "03")
            echo "burpsuite zaproxy ffuf gobuster dirb wfuzz whatweb wafw00f"
            ;;
        "04")
            echo "hashcat john hydra medusa cewl crunch hash-identifier"
            ;;
        "05")
            echo "aircrack-ng wifite reaver kismet hcxtools"
            ;;
        "06")
            echo "msfconsole searchsploit crackmapexec"
            ;;
        "07")
            echo "chisel pwncat evil-winrm impacket-scripts bloodhound"
            ;;
        "08")
            echo "autopsy sleuthkit volatility3 foremost scalpel binwalk photorec testdisk"
            ;;
        "09")
            echo "ghidra r2 gdb ltrace strace objdump checksec"
            ;;
        "10")
            echo "wireshark tshark tcpdump ettercap bettercap mitmproxy responder"
            ;;
        "11")
            echo "snort suricata fail2ban rkhunter chkrootkit clamav lynis"
            ;;
        "12")
            echo "tor torsocks proxychains4 macchanger bleachbit"
            ;;
        "13")
            echo "alphha-report pipal dradis"
            ;;
        "14")
            echo "htop btop tmux docker systemctl"
            ;;
        "15")
            echo "alphha-recon alphha-vuln alphha-report alphha-backup alphha-clean alphha-update"
            ;;
    esac
}

# Launch tool
launch_tool() {
    local tool="$1"

    case "$tool" in
        "msfconsole")
            msfconsole
            ;;
        "burpsuite")
            burpsuite &
            ;;
        "zaproxy")
            zaproxy &
            ;;
        "wireshark")
            wireshark &
            ;;
        "ghidra")
            ghidra &
            ;;
        "autopsy")
            autopsy &
            ;;
        *)
            if command -v "$tool" &>/dev/null; then
                echo -e "${CYAN}Launching $tool...${NC}"
                echo -e "${YELLOW}Press Enter to continue or type arguments:${NC}"
                read -r args
                if [[ -n "$args" ]]; then
                    $tool $args
                else
                    $tool --help 2>/dev/null || $tool -h 2>/dev/null || $tool
                fi
            else
                echo -e "${RED}Tool '$tool' is not installed.${NC}"
                echo -e "${YELLOW}Install with: sudo apt install $tool${NC}"
            fi
            ;;
    esac
}

# Category menu
show_category_menu() {
    local category="$1"
    local category_name="${CATEGORIES[$category]}"
    local tools
    tools=$(get_tools "$category")

    local options=()
    local i=1
    for tool in $tools; do
        options+=("$i" "$tool")
        ((i++))
    done
    options+=("0" "Back to Main Menu")

    local choice
    choice=$(dialog --clear --backtitle "Alphha Security OS" \
        --title "[ $category_name ]" \
        --menu "Select a tool:" 20 60 15 \
        "${options[@]}" 2>&1 >/dev/tty)

    if [[ "$choice" == "0" || -z "$choice" ]]; then
        return
    fi

    # Get selected tool
    local tool_array=($tools)
    local selected_tool="${tool_array[$((choice-1))]}"

    clear
    print_banner
    launch_tool "$selected_tool"
    echo ""
    echo -e "${CYAN}Press Enter to continue...${NC}"
    read -r
}

# Main menu
show_main_menu() {
    while true; do
        local options=()
        for key in $(echo "${!CATEGORIES[@]}" | tr ' ' '\n' | sort); do
            options+=("$key" "${CATEGORIES[$key]}")
        done
        options+=("U" "Update System & Tools")
        options+=("Q" "Quit")

        local choice
        choice=$(dialog --clear --backtitle "Alphha Security OS v$VERSION" \
            --title "[ Main Menu ]" \
            --menu "Select a category:" 25 60 18 \
            "${options[@]}" 2>&1 >/dev/tty)

        case "$choice" in
            "U")
                clear
                echo -e "${CYAN}Updating system...${NC}"
                sudo alphha-update
                echo -e "${GREEN}Update complete!${NC}"
                echo -e "${CYAN}Press Enter to continue...${NC}"
                read -r
                ;;
            "Q"|"")
                clear
                echo -e "${GREEN}Thank you for using Alphha Security OS!${NC}"
                exit 0
                ;;
            *)
                show_category_menu "$choice"
                ;;
        esac
    done
}

# Quick launch mode
quick_launch() {
    local tool="$1"
    shift
    if command -v "$tool" &>/dev/null; then
        exec "$tool" "$@"
    else
        echo -e "${RED}Tool '$tool' not found.${NC}"
        exit 1
    fi
}

# Main
main() {
    if [[ $# -gt 0 ]]; then
        quick_launch "$@"
    else
        show_main_menu
    fi
}

main "$@"
