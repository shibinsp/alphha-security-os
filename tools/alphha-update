#!/bin/bash
#===============================================================================
#
#          FILE: alphha-update
#
#         USAGE: sudo alphha-update [OPTIONS]
#
#   DESCRIPTION: System and tools update utility for Alphha Security OS
#
#       OPTIONS: --system     Update system packages only
#                --tools      Update security tools only
#                --wordlists  Update wordlists
#                --exploits   Sync exploit-db
#                --all        Update everything (default)
#                --help       Show help
#
#        AUTHOR: Alphha Team
#     COPYRIGHT: Copyright (c) 2026 Alphha Team
#       LICENSE: BSD-3-Clause
#       VERSION: 1.0.0
#
#===============================================================================

set -euo pipefail

readonly VERSION="1.0.0"
readonly GREEN='\033[0;32m'
readonly CYAN='\033[0;36m'
readonly YELLOW='\033[0;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

log_info()    { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $*" >&2; }
log_step()    { echo -e "${CYAN}[STEP]${NC} $*"; }

print_banner() {
    echo -e "${GREEN}"
    cat << 'EOF'
    _    _       _     _
   / \  | |_ __ | |__ | |__   __ _
  / _ \ | | '_ \| '_ \| '_ \ / _` |
 / ___ \| | |_) | | | | | | | (_| |
/_/   \_\_| .__/|_| |_|_| |_|\__,_|
          |_|  System Updater
EOF
    echo -e "${NC}"
}

usage() {
    cat << EOF
Usage: sudo alphha-update [OPTIONS]

Update Alphha Security OS components.

OPTIONS:
    --system      Update system packages only
    --tools       Update security tools only
    --wordlists   Update wordlists (SecLists, rockyou, etc.)
    --exploits    Sync exploit-db database
    --pip         Update Python packages
    --go          Update Go tools
    --all         Update everything (default)
    --help        Show this help

EXAMPLES:
    sudo alphha-update
    sudo alphha-update --system
    sudo alphha-update --tools --wordlists

COPYRIGHT:
    Copyright (c) 2026 Alphha Team

EOF
    exit 0
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        exit 1
    fi
}

update_system() {
    log_step "Updating system packages..."

    apt-get update
    apt-get upgrade -y
    apt-get dist-upgrade -y
    apt-get autoremove -y
    apt-get autoclean

    log_info "System packages updated"
}

update_tools() {
    log_step "Updating security tools..."

    # Update Metasploit
    if command -v msfupdate &>/dev/null; then
        log_info "Updating Metasploit..."
        msfupdate || true
    fi

    # Update WPScan
    if command -v wpscan &>/dev/null; then
        log_info "Updating WPScan..."
        wpscan --update || true
    fi

    # Update Nuclei templates
    if command -v nuclei &>/dev/null; then
        log_info "Updating Nuclei templates..."
        nuclei -update-templates || true
    fi

    # Update Nmap scripts
    if command -v nmap &>/dev/null; then
        log_info "Updating Nmap scripts..."
        nmap --script-updatedb || true
    fi

    log_info "Security tools updated"
}

update_wordlists() {
    log_step "Updating wordlists..."

    local wordlist_dir="/usr/share/wordlists"
    mkdir -p "$wordlist_dir"

    # Download/update SecLists
    if [[ -d "$wordlist_dir/SecLists" ]]; then
        log_info "Updating SecLists..."
        cd "$wordlist_dir/SecLists" && git pull || true
    else
        log_info "Cloning SecLists..."
        git clone --depth 1 https://github.com/danielmiessler/SecLists.git "$wordlist_dir/SecLists" || true
    fi

    # Extract rockyou if compressed
    if [[ -f "$wordlist_dir/rockyou.txt.gz" && ! -f "$wordlist_dir/rockyou.txt" ]]; then
        log_info "Extracting rockyou.txt..."
        gunzip -k "$wordlist_dir/rockyou.txt.gz" || true
    fi

    log_info "Wordlists updated"
}

update_exploits() {
    log_step "Syncing exploit-db..."

    if command -v searchsploit &>/dev/null; then
        searchsploit -u || true
    fi

    log_info "Exploit-db synced"
}

update_pip() {
    log_step "Updating Python packages..."

    # Update pip itself
    pip3 install --upgrade pip

    # Update common security Python packages
    local packages=(
        "pwntools"
        "impacket"
        "crackmapexec"
        "bloodhound"
        "volatility3"
        "scapy"
        "requests"
        "pycryptodome"
    )

    for pkg in "${packages[@]}"; do
        pip3 install --upgrade "$pkg" 2>/dev/null || true
    done

    log_info "Python packages updated"
}

update_go() {
    log_step "Updating Go tools..."

    if command -v go &>/dev/null; then
        local go_tools=(
            "github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
            "github.com/projectdiscovery/httpx/cmd/httpx@latest"
            "github.com/ffuf/ffuf@latest"
            "github.com/tomnomnom/assetfinder@latest"
            "github.com/tomnomnom/httprobe@latest"
        )

        for tool in "${go_tools[@]}"; do
            log_info "Installing/updating: $tool"
            go install "$tool" 2>/dev/null || true
        done
    fi

    log_info "Go tools updated"
}

update_all() {
    update_system
    update_tools
    update_wordlists
    update_exploits
    update_pip
    update_go
}

# Main
main() {
    print_banner
    check_root

    local do_system=false
    local do_tools=false
    local do_wordlists=false
    local do_exploits=false
    local do_pip=false
    local do_go=false
    local do_all=false

    if [[ $# -eq 0 ]]; then
        do_all=true
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --system)
                do_system=true
                shift
                ;;
            --tools)
                do_tools=true
                shift
                ;;
            --wordlists)
                do_wordlists=true
                shift
                ;;
            --exploits)
                do_exploits=true
                shift
                ;;
            --pip)
                do_pip=true
                shift
                ;;
            --go)
                do_go=true
                shift
                ;;
            --all)
                do_all=true
                shift
                ;;
            --help|-h)
                usage
                ;;
            *)
                log_error "Unknown option: $1"
                usage
                ;;
        esac
    done

    if [[ "$do_all" == true ]]; then
        update_all
    else
        [[ "$do_system" == true ]] && update_system
        [[ "$do_tools" == true ]] && update_tools
        [[ "$do_wordlists" == true ]] && update_wordlists
        [[ "$do_exploits" == true ]] && update_exploits
        [[ "$do_pip" == true ]] && update_pip
        [[ "$do_go" == true ]] && update_go
    fi

    echo ""
    log_info "Update complete!"
}

main "$@"
